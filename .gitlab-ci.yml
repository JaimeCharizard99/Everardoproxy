image: maven:latest

stages:
    - gcp-authenticate
    - deploy

# Get token
.refresh-token:
  image: "google/cloud-sdk:latest"
  before_script:
    # Auth GCP with Service Account
    - export GOOGLE_APPLICATION_CREDENTIALS=$(echo $GCP_SA_CRED)
    - echo ${GOOGLE_APPLICATION_CREDENTIALS} > creds.json
    - export GOOGLE_APPLICATION_CREDENTIALS=creds.json
    - "gcloud config set project $GCP_PROJECT_ID"
    - "gcloud config set account $GCP_SA"
    - "gcloud auth login --cred-file=creds.json"
    - "export TOKEN=$(gcloud auth print-access-token)"
    - "curl --request PUT --header PRIVATE-TOKEN:$API_PAT https://gitlab.com/api/v4/projects/54316165/variables/TOKEN --form value=$TOKEN"


gcp-authenticate:
  extends: [.refresh-token]
  script:
    - "echo Token Generated Successfully"


# Deploy Proxy
mvn-deploy-proxy:
    stage: deploy
    needs: ["get-token"]
    script:
        - "mvn -Pgoogleapi -Pdeployonly install -Dapigee.config.options=create -DproxyName=$PROXY_NAME -Denv=$APIGEE_ENV -Dorg=$GCP_PROJECT_ID -Dtoken=$TOKEN"
